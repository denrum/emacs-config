#+TITLE: My Emacs Configuration
#+AUTHOR: Denis Rumyantsev
#+DATE: $(date +%Y-%m-%d)
#+PROPERTY: header-args :tangle init.el

* Meta Information
  :PROPERTIES:
  :header-args: :tangle init.el
  :END:
  
  #+BEGIN_SRC emacs-lisp
  ;;; init.el --- Literate Configuration
  ;;; Commentary:
  ;; Automatically generated from literate-config.org
  ;;; Code:
  #+END_SRC

 
* Table of Contents :TOC_4:
- [[#overview][Overview]]
- [[#performance-optimizations][Performance Optimizations]]
- [[#package-management][Package Management]]
- [[#ui-customization][UI Customization]]
- [[#completion-system][Completion System]]
- [[#editing-enhancements][Editing Enhancements]]
- [[#language-support][Language Support]]
- [[#version-control][Version Control]]
- [[#key-bindings][Key Bindings]]
- [[#final-settings][Final Settings]]

* Overview
This is my Emacs configuration using the literary programming approach. Each section builds upon the previous ones, documenting not just what each configuration does, but why I chose it. The configuration prioritizes performance, usability, and language-specific features for my development workflow.

* Performance Optimizations
Before loading any packages, let's optimize Emacs for better performance. These settings prevent slowdowns that can happen with larger configurations.

#+begin_src elisp
;; Increase garbage collection threshold for better performance
(setq gc-cons-threshold 100000000)
(setq gc-cons-percentage 0.6)

;; Increase the amount of data which Emacs reads from the process
(setq read-process-output-max (* 1024 1024))

;; Optimize compilation scrolling
(setq compilation-scroll-output t)

;; Disable bidirectional text for slight performance improvement
(setq-default bidi-display-reordering 'left-to-right
              bidi-paragraph-direction 'left-to-right)
#+end_src

* Package Management
Next, we'll set up package management using the built-in =package= system with MELPA as the primary source.

#+begin_src elisp
;; Import and initialize package manager
(require 'package)

;; Add major package repositories
(add-to-list 'package-archives
             '("melpa" . "https://melpa.org/packages/") t)
(add-to-list 'package-archives
             '("gnu" . "https://elpa.gnu.org/packages/") t)

;; Initialize packages
(package-initialize)

;; Refresh package contents on first start
(unless package-archive-contents
  (package-refresh-contents))

;; Install use-package if not already present
(unless (package-installed-p 'use-package)
  (package-install 'use-package))

;; Configure use-package to handle automatic installation
(eval-and-compile
  (setq use-package-always-ensure t))
#+end_src

* UI Customization
Now we'll customize the appearance and behavior of Emacs to create a pleasant, distraction-free environment.

** Basic UI Elements
First, let's remove visual clutter and set up clean defaults:

#+begin_src elisp
;; Disable scroll bars, tool bars, and menu bars
(scroll-bar-mode 0)
(tool-bar-mode 0)
(menu-bar-mode 0)

;; Disable startup screen and initial scratch message
(setq inhibit-startup-screen t
      initial-scratch-message "")

;; Other visual enhancements
(setq scroll-step 1
      make-backup-files nil
      auto-save-default nil
      create-lockfiles nil
      truncate-lines t
      truncate-partial-width-windows nil)

;; Enable pixel-level scrolling
(pixel-scroll-mode t)
(pixel-scroll-precision-mode t)
#+end_src

** Themes and Fonts
Choose a theme and set up the font to create an aesthetically pleasing interface:

#+begin_src elisp
(use-package ef-themes
  :ensure t
  :config
  ;; Apply the theme with a light background
  (load-theme 'ef-cyprus t)
  ;; Set the default font family and size
  (set-face-attribute 'default nil :family "JetBrainsMono Nerd Font Mono" :height 120))
#+end_src

** Additional UI Enhancements
Add visual enhancements for better user experience:

#+begin_src elisp
;; Add padding around the main editing area for a more spacious feel
(use-package spacious-padding
  :ensure t
  :init (spacious-padding-mode 1))

;; Enable line numbers in programming modes
(add-hook 'prog-mode-hook
          (lambda ()
            (setq display-line-numbers-width 4)
            (display-line-numbers-mode 1)))

;; Add highlighting to current line in directories
(add-hook 'dired-after-readin-hook 'hl-line-mode)

;; Set up a nice-looking modeline
(use-package doom-modeline
  :ensure t
  :init (doom-modeline-mode 1)
  :config
  (setq doom-modeline-height 30
        doom-modeline-total-line-number t))

;; Add a fun visualization to show scroll position
(use-package nyan-mode
  :ensure t
  :init (nyan-mode 1))

;; Add visual indentation guides
(use-package indent-bars
  :ensure t
  :hook ((csharp-mode) . indent-bars-mode)
  :custom
  (indent-bars-width-frac 0.1))
#+end_src

* Completion System
Set up a powerful completion system for navigating files and buffers efficiently.

** Ivy and Associated Packages
Install and configure the core completion system:

#+begin_src elisp
;; Configure the core completion system with IVY
(use-package ivy
  :ensure t
  :diminish
  :config
  (ivy-mode 1)
  ;; Configure completion styles
  (setq completion-styles '(basic substring partial-completion flex)
        ivy-use-virtual-buffers t
        ivy-height 15
        ivy-count-format "(%d/%d) "))

;; Install Counsel for enhanced commands
(use-package counsel
  :ensure t
  :diminish
  :config
  ;; Enable counsel-mode to enhance built-in functions
  (counsel-mode 1))

;; Use vertical completion UI
(use-package vertico
  :ensure t
  :init
  (vertico-mode))

;; Add annotations to completion candidates
(use-package marginalia
  :ensure t
  :config
  (marginalia-mode))
#+end_src

** Better Scrolling Experience
Enhance the scrolling experience with ultra-scroll:

#+begin_src elisp
(use-package ultra-scroll
  :ensure t
  :vc (:url "https://github.com/jdtsmith/ultra-scroll" :rev :newest)
  :init
  (setq scroll-conservatively 101  ; important!
        scroll-margin 0)
  :config
  (ultra-scroll-mode 1))
#+end_src

* Editing Enhancements
Configure packages that improve the editing experience.

** Brackets and Parentheses Management
Better handling of parentheses and brackets:

#+begin_src elisp
(use-package smartparens
  :ensure t
  :config
  (require 'smartparens-config)
  (smartparens-global-mode 1)
  ;; Enable special pairing in programming modes
  (add-hook 'prog-mode-hook 'turn-on-smartparens-mode))
#+end_src

** Show Available Key Bindings
Display available key bindings in a popup:

#+begin_src elisp
(use-package which-key
  :ensure t
  :init
  (which-key-mode 1)
  :config
  (setq which-key-idle-delay 0.5
        which-key-idle-secondary-delay 0.0))
#+end_src

* Language Support
Configure language-specific features and LSP support for development.

** Universal LSP Client
Set up Eglot as the preferred LSP client for various languages:

#+begin_src elisp
(use-package eglot
  :ensure t
  :hook ((clojure-mode . eglot-ensure)
         (csharp-mode . eglot-ensure)
         (go-mode . eglot-ensure)
         (go-ts-mode . eglot-ensure)
         (rust-mode . eglot-ensure)
         (sql-mode . eglot-ensure)
         (python-mode . eglot-ensure))
  :config
  (setq eglot-sync-connect 1
        eglot-connect-timeout 300)
  
  ;; Configure server-specific settings
  (add-to-list 'eglot-server-programs
               '(csharp-mode . ("/home/denis/Projects/dotnet/omnisharp-roslyn/bin/Debug/OmniSharp.Stdio.Driver/net6.0/publish/OmniSharp" "-lsp")))
  
  ;; SQLs language server configuration
  (defclass eglot-sqls (eglot-lsp-server) () :documentation "SQL's Language Server")
  (add-to-list 'eglot-server-programs
               '(sql-mode . (eglot-sqls "sqls")))
  
  ;; Configure SQL buffer display
  (add-to-list 'display-buffer-alist
               '("\\*sqls\\*"
                 (display-buffer-reuse-window display-buffer-at-bottom)
                 (reusable-frames . visible)
                 (window-height . 0.3))))
#+end_src

** Clojure Development
Set up CIDER for Clojure development:

#+begin_src elisp
(use-package cider
  :ensure t
  :config
  (setq cider-repl-display-in-current-window t
        cider-show-error-buffer t
        cider-suggest-refactoring-imports t
        cider-completion-use-context 'always
        cider-font-lock-dynamically '(macro core function var)
        cider-prefer-local-resources t
        cider-repl-history-file "~/.emacs.d/cider-history"
        cider-repl-pop-to-buffer-on-connect 'nil
        cider-repl-use-clojure-font-lock t
        cider-repl-wrap-history t))
#+end_src

** Rust Development
Configuration for Rust development:

#+begin_src elisp
(use-package rust-mode
  :ensure t
  :mode "\\.rs\\'"
  :init
  (setq rust-format-on-save t))
#+end_src

** Go Development
Configuration for Go development:

#+begin_src elisp
(use-package go-mode
  :ensure t
  :mode "\\.go\\'"
  :init
  (add-hook 'go-mode-hook
            (lambda ()
              (setq tab-width 4)
              (setq indent-tabs-mode t))))
#+end_src

** Python Development
Basic Python setup:

#+begin_src elisp
(use-package python-mode
  :ensure t
  :mode "\\.py\\'"
  :interpreter "python")
#+end_src

* Version Control
Configure Magit for Git workflows:

#+begin_src elisp
(use-package magit
  :ensure t
  :bind (("C-c g" . magit-status))
  :config
  (setq magit-stage-all-confirm nil
        magit-unstage-all-confirm nil
        magit-save-repository-buffers 'dont-ask))
#+end_src

* Project Management
Set up projectile for project-wide operations:

#+begin_src elisp
(use-package projectile
  :ensure t
  :init
  (projectile-mode 1)
  :bind-keymap
  ("C-c p" . projectile-command-map)
  :config
  (setq projectile-completion-system 'ivy
        projectile-indexing-method 'alien
        projectile-enable-caching t
        projectile-sort-order 'recentf))
#+end_src

* Key Bindings
Finally, we'll set up a comprehensive key binding system using General.el for a consistent experience.

** Leader Key Definition
We'll define a Spacemacs-like leader key for common operations:

#+begin_src elisp
(use-package general
  :ensure t
  :config
  ;; Define the leader key
  (general-create-definer leader-def
    :states 'motion
    :keymaps 'override
    :prefix "SPC"
    :global-prefix "M-SPC")

  ;; Define program-specific prefix
  (general-create-definer prog-def
    :prefix "C-c")

  ;; Program-specific bindings
  (prog-def
    "a" '(eglot-code-actions :which-key "code actions")
    "r" '(eglot-rename :which-key "rename")
    "o" '(eglot-code-action-organize-imports :which-key "organize imports")
    "h" '(eldoc :which-key "doc"))

  ;; File operations
  (leader-def
    "f" '(:ignore t :which-key "file")
    "f f" '(counsel-find-file :which-key "find file")
    "f s" '(save-buffer :which-key "save file"))

  ;; Search
  (leader-def
    "/" 'counsel-rg)

  ;; Sexp manipulation (for Lisp-like languages)
  (leader-def
    "k" '(:ignore t :which-key "sexp")
    "k w" '(sp-wrap-round :which-key "wrap ()")
    "k [" '(sp-wrap-square :which-key "wrap []")
    "k {" '(sp-wrap-curly :which-key "wrap {}")
    "k ," '(sp-forward-barf-sexp :which-key "barf <-)")
    "k ." '(sp-forward-slurp-sexp :which-key "slurp ->)")
    "k <" '(sp-backward-barf-sexp :which-key "barf (-<")
    "k >" '(sp-forward-slurp-sexp :which-key "slurp (>->")
    "k d" '(sp-kill-sexp :which-key "delete sexp")
    "k r" '(sp-raise-sexp :which-key "raise sexp")
    "k y" '(sp-copy-sexp :which-key "copy sexp"))

  ;; Window management
  (leader-def
    "w" '(:ignore t :which-key "window")
    "w v" '(split-window-right :which-key "split vertically")
    "w s" '(split-window-below :which-key "split horizontally")
    "w k" '(windmove-up :which-key "focus ↑")
    "w h" '(windmove-left :which-key "focus ←")
    "w j" '(windmove-down :which-key "focus ↓")
    "w l" '(windmove-right :which-key "focus →")
    "w d" '(delete-window :which-key "delete window"))

  ;; Buffer management
  (leader-def
    "b" '(:ignore t :which-key "buffer")
    "b b" '(ivy-switch-buffer :which-key "switch buffer")
    "b l" '(previous-buffer :which-key "last buffer")
    "b d" 'kill-current-buffer)

  ;; Code operations
  (leader-def
    "c" '(:ignore t :which-key "code")
    "c a" 'eglot-code-actions
    "c l" 'comment-or-uncomment-region
    "c f b" 'eglot-format-buffer
    "c f r" 'eglot-format
    "c w s" 'word-to-underscore
    "c r" 'eglot-rename)

  ;; Navigation
  (leader-def
    "g" '(:ignore t :which-key "goto")
    "g d" 'xref-find-definitions
    "g b" 'xref-go-back
    "g f" 'xref-go-forward
    "g i" 'xref-find-implementation)

  ;; Project operations
  (leader-def
    "p" '(:ignore t :which-key "project")
    "p f" '(projectile-find-file :which-key "find file in project")
    "p g" '(projectile-grep :which-key "grep in project")
    "p a" '(projectile-toggle-between-implementation-and-test :which-key "<-> test")
    "p p" '(projectile-switch-project :which-key "switch project"))

  ;; Open operations
  (leader-def
    "o" '(:ignore t :which-key "open")
    "o p" 'treemacs)

  ;; Execute command
  (leader-def
    "SPC" '(execute-extended-command :which-key "M-x"))

  ;; Ivy navigation
  (general-define-key
   :keymaps 'ivy-mode-map
   "C-j" 'ivy-next-line
   "C-k" 'ivy-previous-line)

  ;; Emacs Lisp specific bindings
  (leader-def
    :keymaps 'emacs-lisp-mode-map
    "m" '(:ignore t :which-key "emacs lisp")
    "m e" '(:ignore t :which-key "eval")
    "m e e" 'eval-last-sexp
    "m e d" 'eval-defun
    "m e b" 'eval-buffer)

  ;; Clojure specific bindings
  (leader-def
    :keymaps 'clojure-mode-map
    "m" '(:ignore t :which-key "clojure")
    "m e" '(:ignore t :which-key "eval")
    "m e e" 'cider-eval-end-of-sexp
    "m e d" 'cider-eval-defun-at-point
    "m c" 'cider-connect-clj
    "m e b" 'cider-eval-buffer
    "m r n" 'cider-repl-set-ns
    "m g g" 'xref-find-definitions
    "m r r" 'eglot-rename
    "m t r" 'cider-test-run-test
    "m t n" 'cider-test-run-ns-tests
    "m d d" 'cider-doc)

  ;; Escape key configuration
  (general-define-key
   "<escape>" 'keyboard-escape-quit))
#+end_src

* Final Settings
Wrap up with some final configuration settings and cleanup:

#+begin_src elisp
;; Allow custom variables to be saved properly
(setq custom-safe-things t)

;; Provide the configuration
(provide 'init)
;;; init.el ends here
#+end_src
