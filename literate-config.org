#+TITLE: My Emacs Configuration
#+AUTHOR: Denis Rumyantsev
#+DATE: $(date +%Y-%m-%d)
#+PROPERTY: header-args :tangle ~/.emacs.d/init.el

* Meta Information
  :PROPERTIES:
  :header-args: :tangle ~/.emacs.d/init.el
  :END:
  
  #+BEGIN_SRC emacs-lisp
;; -*- lexical-binding: t -*-
;; init.el - Literate Configuration
;;; Commentary:
;; Automatically generated from literate-config.org
;;; Code:
  #+END_SRC

* Table of Contents :TOC_2:
- [[#meta-information][Meta Information]]
- [[#new-block][New block]]
- [[#overview][Overview]]
- [[#performance-optimizations][Performance Optimizations]]
- [[#package-management][Package Management]]
- [[#ui-customization][UI Customization]]
  - [[#basic-ui-elements][Basic UI Elements]]
  - [[#themes-and-fonts][Themes and Fonts]]
  - [[#additional-ui-enhancements][Additional UI Enhancements]]
  - [[#better-scrolling-experience][Better Scrolling Experience]]
- [[#completion-system][Completion System]]
  - [[#ivy-and-associated-packages][Ivy and Associated Packages]]
- [[#editing-enhancements][Editing Enhancements]]
  - [[#brackets-and-parentheses-management][Brackets and Parentheses Management]]
  - [[#show-available-key-bindings][Show Available Key Bindings]]
- [[#project-management][Project Management]]
- [[#development][Development]]
  - [[#enable-line-number-in-programming-modes][Enable line number in programming modes]]
  - [[#treemacs][Treemacs]]
  - [[#debugger-support][Debugger Support]]
  - [[#company-completion][Company Completion]]
  - [[#code-checking][Code Checking]]
  - [[#netc-development][.NET/C# Development]]
  - [[#yaml][Yaml]]
  - [[#docker][Docker]]
  - [[#httprest-client][HTTP/REST Client]]
  - [[#universal-lsp-client][Universal LSP Client]]
  - [[#clojure-development][Clojure Development]]
  - [[#rust-development][Rust Development]]
  - [[#go-development][Go Development]]
  - [[#common-lisp-support][Common lisp support]]
  - [[#databasesql-support][Database/SQL Support]]
  - [[#python-development][Python Development]]
- [[#org-mode-enhancements][Org Mode Enhancements]]
- [[#ai][AI]]
- [[#version-control][Version Control]]
- [[#dashboard][Dashboard]]
- [[#key-bindings][Key Bindings]]
  - [[#leader-key-definition][Leader Key Definition]]
- [[#my-additional-functions][My additional functions]]
  - [[#uuid-generation][UUID generation]]
  - [[#text-transformation][Text transformation]]
- [[#final-settings][Final Settings]]

* New block

* Overview
This is my Emacs configuration using the literary programming approach. Each section builds upon the previous ones, documenting not just what each configuration does, but why I chose it. The configuration prioritizes performance, usability, and language-specific features for my development workflow.

* Performance Optimizations
Before loading any packages, let's optimize Emacs for better performance. These settings prevent slowdowns that can happen with larger configurations.

#+begin_src elisp
;; Increase garbage collection threshold for better performance
(setq gc-cons-threshold 100000000)
(setq gc-cons-percentage 0.6)

;; Increase the amount of data which Emacs reads from the process
(setq read-process-output-max (* 1024 1024))

;; Optimize compilation scrolling
(setq compilation-scroll-output t)

;; Disable bidirectional text for slight performance improvement
(setq-default bidi-display-reordering 'left-to-right
              bidi-paragraph-direction 'left-to-right)
#+end_src

* Package Management
Next, we'll set up package management using the built-in =package= system with MELPA as the primary source.

#+begin_src elisp
  ;; Import and initialize package manager
  (require 'package)

  ;; Add major package repositories
  (add-to-list 'package-archives
               '("melpa" . "https://melpa.org/packages/") t)
  (add-to-list 'package-archives
               '("gnu" . "https://elpa.gnu.org/packages/") t)

  ;; Initialize packages
  (package-initialize)

  ;; Refresh package contents on first start
  (unless package-archive-contents
    (package-refresh-contents))

  ;; Install use-package if not already present
  (unless (package-installed-p 'use-package)
    (package-install 'use-package))

  ;; Configure use-package to handle automatic installation
  (eval-and-compile
    (setq use-package-always-ensure t))

  (require 'use-package)
#+end_src


* UI Customization
Now we'll customize the appearance and behavior of Emacs to create a pleasant, distraction-free environment.

** Basic UI Elements
First, let's remove visual clutter and set up clean defaults:

#+begin_src elisp
;; Disable scroll bars, tool bars, and menu bars
(scroll-bar-mode 0)
(tool-bar-mode 0)
(menu-bar-mode 0)

;; Disable startup screen and initial scratch message
(setq inhibit-startup-screen t
      initial-scratch-message "")

;; Other visual enhancements
(setq scroll-step 1
      make-backup-files nil
      auto-save-default nil
      create-lockfiles nil
      truncate-lines t
      truncate-partial-width-windows nil)

;; Enable pixel-level scrolling
(pixel-scroll-mode t)
(pixel-scroll-precision-mode t)
#+end_src

** Themes and Fonts
Choose a theme and set up the font to create an aesthetically pleasing interface:

#+begin_src elisp
  (use-package ef-themes
        :ensure t
          :config
          ;; Apply the theme with a light background
          (load-theme 'ef-cyprus t)
          ;; Set the default font family and size
          (set-face-attribute 'default nil :family "JetBrainsMono Nerd Font Mono" :height 110))

      ;; (use-package 
      ;;   doom-themes
      ;;   :ensure t
      ;;   :config
      ;;   ;; Global settings (defaults)
      ;;   (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
      ;;         doom-themes-enable-italic t) ; if nil, italics is universally disabled
      ;;   ;;(load-theme 'doom-flatwhite t)
      ;;   (load-theme 'doom-one-light)
      ;;   ;;(load-theme 'doom-one t)
      ;;   ;;(load-theme 'doom-nord t)
      ;;   ;;(load-theme 'doom-tomorrow-day t)
      ;;   ;;(load-theme 'doom-opera-light t)
      ;;   ;;(load-theme 'doom-nord-light t)
      ;;   ;;(set-face-attribute 'default nil :family "Iosevka Nerd Font" :height 130)
      ;;   ;; (set-face-attribute 'default nil :family "Ubuntu Mono" :height 120)
      ;;   ;; (set-face-attribute 'default nil :family "Berkeley Mono" :height 120)
      ;;   ;; (set-face-attribute 'default nil :family "JetBrainsMono Nerd Font Mono" :height 110)
      ;;   ;;(set-face-attribute 'default nil :family "JetBrainsMono Nerd Font Mono" :height 120)
      ;;   (doom-themes-org-config)
      ;;   (doom-themes-visual-bell-config) ;Моргаем строкой состояния вместо сигнала
      ;;   ;;(setq default-text-properties '(line-spacing 0.0 line-height 1.2))
      ;;   ;;(set-face-attribute 'default nil :family "Monaspace Krypton" :height 120))
      ;;   ;; (set-face-attribute 'default nil :family "SpaceMono Nerd Font" :height 120))
      ;;   ;;(set-face-attribute 'default nil :family "monospace" :height 120))
    ;; 	)          
#+end_src

** Additional UI Enhancements
Add visual enhancements for better user experience:

#+begin_src elisp
;; Add padding around the main editing area for a more spacious feel
(use-package spacious-padding
  :ensure t
  :init (spacious-padding-mode 1))

;; Add highlighting to current line in directories
(add-hook 'dired-after-readin-hook 'hl-line-mode)

;; Set up a nice-looking modeline
(use-package doom-modeline
  :ensure t
  :init (doom-modeline-mode 1)
  :config
  (setq doom-modeline-height 30
        doom-modeline-total-line-number t))

;; Add a fun visualization to show scroll position
(use-package nyan-mode
  :ensure t
  :init (nyan-mode 1))

;; Add visual indentation guides
(use-package indent-bars
  :ensure t
  :hook ((csharp-mode) . indent-bars-mode)
  :custom
  (indent-bars-width-frac 0.1))


;;(use-package nerd-icons
;;  :ensure t)

;;(setq nerd-icons-font-family "Symbols Nerd Font Mono")

;; Dired settings
(setq delete-by-moving-to-trash t)
#+end_src

** Better Scrolling Experience
Enhance the scrolling experience with ultra-scroll:

#+begin_src elisp
  (use-package ultra-scroll
      :ensure t
      :vc (:url "https://github.com/jdtsmith/ultra-scroll" :rev :newest)
      :init
      (setq scroll-conservatively 101  ; important!
            scroll-margin 0)
      :config
      (ultra-scroll-mode 1))
#+end_src


* Completion System
Set up a powerful completion system for navigating files and buffers efficiently.

** Ivy and Associated Packages
Install and configure the core completion system:

#+begin_src elisp
;; Configure the core completion system with IVY
(use-package ivy
  :ensure t
  :diminish
  :config
  (ivy-mode 1)
  ;; Configure completion styles
  (setq completion-styles '(basic substring partial-completion flex)
        ivy-use-virtual-buffers t
        ivy-height 15
        ivy-count-format "(%d/%d) "))

;; Install Counsel for enhanced commands
(use-package counsel
  :ensure t
  :diminish
  :config
  ;; Enable counsel-mode to enhance built-in functions
  (counsel-mode 1))

;; Use vertical completion UI
(use-package vertico
  :ensure t
  :init
  (vertico-mode))

;; Add annotations to completion candidates
(use-package marginalia
  :ensure t
  :config
  (marginalia-mode))
#+end_src


* Editing Enhancements
Configure packages that improve the editing experience.

** Brackets and Parentheses Management
Better handling of parentheses and brackets:

#+begin_src elisp
(use-package smartparens
  :ensure t
  :config
  (require 'smartparens-config)
  (smartparens-global-mode 1)
  ;; Enable special pairing in programming modes
  (add-hook 'prog-mode-hook 'turn-on-smartparens-mode)
  ;; Specific mode hooks for clojure and emacs-lisp
  (add-hook 'clojure-mode-hook 'smartparens-mode)
  (add-hook 'emacs-lisp-mode-hook 'smartparens-mode))
#+end_src

** Show Available Key Bindings
Display available key bindings in a popup:

#+begin_src elisp
(use-package which-key
  :ensure t
  :init
  (which-key-mode 1)
  :config
  (setq which-key-idle-delay 0.5
        which-key-idle-secondary-delay 0.0))
#+end_src


* Development
Configure language-specific features and LSP support for development.

** Enable line number in programming modes

#+begin_src elisp
;; Enable line numbers in programming modes
(add-hook 'prog-mode-hook
          (lambda ()
            (setq display-line-numbers-width 4)
            (display-line-numbers-mode 1)))
#+end_src

** Treemacs

#+begin_src elisp
      ;; Treemacs file tree
  (use-package treemacs
    :ensure t
    :bind (("C-c C-t" . treemacs))
    :config
    (setq treemacs-follow-after-init t)
    (setq treemacs-follow-mode -1)
    )

  (use-package treemacs-all-the-icons
    :ensure t)

  (treemacs-load-all-the-icons-with-workaround-font "Hermit")
  ;;(setq treemacs-indentation '(20 px))

  (use-package treemacs-icons-dired
    :hook (dired-mode . treemacs-icons-dired-enable-once)
    :ensure t)

  ;; (set-face-attribute 'treemacs-file-face nil :foreground "#555555")
  ;; (set-face-attribute 'treemacs-file-face nil :height 100)
  ;; (set-face-attribute 'treemacs-directory-face nil :height 100)
  ;; (set-face-attribute 'treemacs-directory-collapsed-face nil :height 100)
  ;; (set-face-attribute 'treemacs-file-face nil :family "Berkeley Mono")

  ;; (set-face-attribute 'treemacs-file-face nil :height 100)
  ;; (set-face-attribute 'treemacs-directory-face nil :height 100)
  ;; (set-face-attribute 'treemacs-git-modified-face nil :height 100)
  ;;(set-face-attribute 'treemacs-all-the-icons-root-face nil :height 120)
  ;;(set-face-attribute 'treemacs-all-the-icons-file-face nil :height 120)
  ;;(set-face-attribute 'treemacs-all-the-icons-file-face nil :height 50)

  ;;(set-face-attribute 'treemacs-nerd-icons-root-face nil :height 150)

  ;;(treemacs-load-all-the-icons-with-workaround-font "JetBrainsMono Nerd Font Mono")

  ;;(treemacs-resize-icons 20)

#+end_src

** Debugger Support
Set up debugging support with Dape:

#+begin_src elisp
(use-package dape
  :ensure t
  ;;:preface
  ;; By default dape shares the same keybinding prefix as `gud'
  ;; If you do not want to use any prefix, set it to nil.
  ;; (setq dape-key-prefix "\C-x\C-a")

  ;;:hook
  ;; Save breakpoints on quit
  ;; ((kill-emacs . dape-breakpoint-save)
  ;; Load breakpoints on startup
  ;;  (after-init . dape-breakpoint-load))

  :config
  ;; Turn on global bindings for setting breakpoints with mouse
  (dape-breakpoint-global-mode)

  ;; Info buffers to the right
  (setq dape-buffer-window-arrangement 'right)

  ;; Info buffers like gud (gdb-mi)
  ;; (setq dape-buffer-window-arrangement 'gud)
  ;; (setq dape-info-hide-mode-line nil)

  ;; Pulse source line (performance hit)
  (add-hook 'dape-display-source-hook 'pulse-momentary-highlight-one-line)

  ;; Showing inlay hints
  (setq dape-inlay-hints t)

  ;; Save buffers on startup, useful for interpreted languages
  ;; (add-hook 'dape-start-hook (lambda () (save-some-buffers t t)))

  ;; Kill compile buffer on build success
  (add-hook 'dape-compile-hook 'kill-buffer)

  (add-to-list 'dape-configs `(netcoredbg
     modes (csharp-mode csharp-ts-mode)
     ensure dape-ensure-command
     command "netcoredbg"
     command-args ["--interpreter=vscode"]
     :request "launch"
     :cwd sharper--nearest-project-dir
     :program find-current-file-project-dll
	 :stopAtEntry nil))

  ;; (add-to-list 'dape-configs `(dlv
  ;;    modes (go-mode go-ts-mode)
  ;;    ensure dape-ensure-command
  ;;    command "dlv"
  ;;    command-args ["test" "neltom.com/system/locations" "--listen" "127.0.0.1::autoport" "--allow-non-terminal-interactive=true"]
  ;; 	 command-cwd dape-command-cwd
  ;; 	 port :autoport
  ;; 	 command-insert-stderr t
  ;;    :request "launch"
  ;; 	 :type "debug"
  ;;    :cwd "."
  ;;    :program "."
  ;; 	 :stopAtEntry nil))
  )

;;(setq dape-debug t)


;; Enable repeat mode for more ergonomic `dape' use
(use-package repeat
  :config
  (repeat-mode))
#+end_src

** Company Completion
Configure Company for auto-completion:

#+begin_src elisp
(use-package company
  :ensure t
  :hook ((emacs-lisp-mode clojure-mode lisp-mode csharp-mode go-mode go-ts-mode) . company-mode)
  )

(setq company-show-quick-access t
      company-tooltip-align-annotations t
      company-idle-delay 0.2
      company-minimum-prefix-length 2
      company-tooltip-limit 20)

(eval-after-load 'company
  '(add-to-list 'company-backends 'company-capf))
#+end_src
** Code Checking
Set up on-the-fly syntax checking with Flycheck:

#+begin_src elisp
(use-package flycheck
  :ensure t
  :hook ((emacs-lisp-mode clojure-mode) . flycheck-mode))
#+end_src

** .NET/C# Development
Set up support for .NET and C# development:

#+begin_src elisp
;; C# project file handling
(add-to-list 'auto-mode-alist '("\\.csproj" . nxml-mode))

;;Sharper - C# development utilities
(use-package sharper
  :ensure t
  :vc (:url "https://github.com/sebasmonia/sharper" :rev :newest)
  :bind
  ("C-c n" . sharper-main-transient))

(require 'sharper)

(require 'xml)

(defun read-xml-file (file)
  "Read xml FILE to temp buffer."
  (with-temp-buffer
    (insert-file-contents file)
    (libxml-parse-xml-region (point-min) (point-max))))

(require 'dom)

(defun find-tag-value (xml tag)
  "Find the value of the first occurrence of TAG in the XML/HTML tree XML."
  (car (cddr (car (dom-by-tag xml tag)))))

(defun find-current-file-project-dll ()
  "Find dll name of current file project."
  (let* ((csproj (file-relative-name (car (file-expand-wildcards (file-name-concat (sharper--nearest-project-dir) "*.csproj")))))
		 (dir (file-name-directory csproj))
		 (xml-data (read-xml-file csproj))
		 (assembly-name (find-tag-value xml-data 'AssemblyName))
		 (assembly-file-name (if assembly-name
								 (concat assembly-name ".dll")
							   (concat (file-name-base csproj) ".dll"))))
	(file-relative-name
	 (file-relative-name
	  (car
	   (file-expand-wildcards
		(file-name-concat dir "bin" "Debug" "*" assembly-file-name)))))))

(require 'cl-lib)

(defvar nunit-test-methodfunc-template "dotnet test --filter %e --logger \"trx;LogFileName=%f\"" "Template for \"dotnet test\" invocations to run the \"current test\".")

(defun nunit-run-test-at-point (&optional _transient-params)
  "Run \"dotnet test\", ignore TRANSIENT-PARAMS, setup call via `sharper--current-test'."
  (interactive
   (list (transient-args 'sharper-transient-test)))
  ;;(transient-set)
  (if sharper--current-test
      (let* ((temp-file (make-temp-file "dotnet"))
			 (default-directory (car sharper--current-test))
             (command (sharper--strformat nunit-test-methodfunc-template
                                          ?e (shell-quote-argument (cdr sharper--current-test))
										  ?f temp-file)))
        (sharper--log-command "Testing method/function at point" command)
        (compile command))
    ;; go back to the main menu if sharper--current-test is not set
    (sharper-main-transient)))
#+end_src

** Yaml
#+begin_src elisp
(use-package yaml-mode
  :ensure t)
#+end_src

** Docker
#+begin_src elisp
(use-package dockerfile-mode
  :ensure t)

(use-package docker
  :ensure t)

(use-package docker-compose-mode
  :ensure t)  
#+end_src

** HTTP/REST Client
Set up restclient for HTTP requests:

#+begin_src elisp
(use-package restclient
  :ensure t)
#+end_src

** Universal LSP Client
Set up Eglot as the preferred LSP client for various languages:

#+begin_src elisp
(use-package eglot
  :ensure t
  :hook ((clojure-mode . eglot-ensure)
         (csharp-mode . eglot-ensure)
         (go-mode . eglot-ensure)
         (go-ts-mode . eglot-ensure)
         (rust-mode . eglot-ensure)
         (sql-mode . eglot-ensure)
         (python-mode . eglot-ensure))
  :config
  (setq eglot-sync-connect 1
        eglot-connect-timeout 300)
  
  ;; Configure server-specific settings
  (add-to-list 'eglot-server-programs
               '(csharp-mode . ("/home/denis/Projects/dotnet/omnisharp-roslyn/bin/Debug/OmniSharp.Stdio.Driver/net6.0/publish/OmniSharp" "-lsp")))
  
  ;; SQLs language server configuration
  (defclass eglot-sqls (eglot-lsp-server) () :documentation "SQL's Language Server")
  (add-to-list 'eglot-server-programs
               '(sql-mode . (eglot-sqls "sqls")))
  
  ;; Configure SQL buffer display
  (add-to-list 'display-buffer-alist
               '("\\*sqls\\*"
                 (display-buffer-reuse-window display-buffer-at-bottom)
                 (reusable-frames . visible)
                 (window-height . 0.3))))
#+end_src
** Clojure Development
Set up CIDER for Clojure development:

#+begin_src elisp
(use-package cider
  :ensure t
  :config
  (setq cider-repl-display-in-current-window t
        cider-show-error-buffer t
        cider-suggest-refactoring-imports t
        cider-completion-use-context 'always
        cider-font-lock-dynamically '(macro core function var)
        cider-prefer-local-resources t
        cider-repl-history-file "~/.emacs.d/cider-history"
        cider-repl-pop-to-buffer-on-connect 'nil
        cider-repl-use-clojure-font-lock t
        cider-repl-wrap-history t))
#+end_src

** Rust Development
Configuration for Rust development:

#+begin_src elisp
(use-package rust-mode
  :ensure t
  :mode "\\.rs\\'"
  :init
  (setq rust-format-on-save t))
#+end_src

** Go Development
Configuration for Go development:

#+begin_src elisp
  (use-package go-mode
    :ensure t
    :init (add-hook 'go-mode-hook (lambda () (add-hook 'before-save-hook 'gofmt-before-save nil t)))
    :bind (("C-c c" . comment-or-uncomment-region)
  		 ("C-c t d" . my/dape-debug-go-test)))

  ;; (add-hook 'go-ts-mode-hook
  ;; 		  (lambda ()
  ;; 			(add-hook 'before-save-hook 'gofmt-before-save)))

  ;; (add-hook 'go-mode-hook
  ;; 		  (lambda ()
  ;; 			(add-hook 'before-save-hook 'gofmt-before-save)))

  (setq-default tab-width 4)
  (setq-default go-ts-mode-indent-offset 4)

  ;; (add-hook 'go-mode-hook 'lsp-deferred)
  ;; (add-hook 'go-mode-hook #'flycheck-mode)

  ;; Additional Go packages
  (use-package gotest
    :ensure t
    :after (go-mode go-ts-mode)
    :bind (:map go-mode-map
                ("C-c t f" . go-test-current-file)
                ("C-c t t" . go-test-current-test)
                ("C-c t j" . go-test-current-project)
                ("C-c t b" . go-test-current-benchmark)
                ("C-c t c" . go-test-current-coverage)
                ("C-c t x" . go-run)))

  (use-package go-tag
    :ensure t
    :bind (:map go-mode-map
                ("C-c t a" . go-tag-add)
                ("C-c t r" . go-tag-remove))
    :init (setq go-tag-args (list "-transform" "camelcase")))

  (use-package templ-ts-mode
    :ensure t)

  (add-hook 'templ-ts-mode-hook
            (lambda ()
              (add-hook 'after-save-hook
                        (lambda ()
                          (when (string-match "\\.templ\\'" (buffer-file-name))
                            (let ((file (buffer-file-name)))
                            (shell-command (concat "templ fmt " (shell-quote-argument file)))
                            (revert-buffer t t t))) ; Автоматически перечитать
                        nil t))))
#+end_src

Config dape for go
#+begin_src elisp
(require 'gotest)

(defun my/dape-debug-go-test ()
  "Запуск отладки текущего Go-теста с dape-mode."
  (interactive)
  (let ((test-package (go-test--gb-find-package))
		(test-name (go-test--get-current-test))) ; Получить имя теста под курсором
	(message "Current test: %s in %s" test-name test-package)
	(message "Current file testing data: %s" (go-test--get-current-file-testing-data))
    (dape
     `(:name "Debug Go Test"
       :type "debug"
       :request "launch"
       :mode "test"
	   :cwd "."
       :program "." ;;,(expand-file-name (buffer-file-name)) ; Путь к текущему файлу
       :args ["run" ,(concat "^" test-name "$")] ; Запуск конкретного теста
       command "dlv" ;;,(executable-find "dlv") ; Путь к dlv (автоматически ищется в PATH)
	   command-cwd ,test-package
       command-insert-stderr t
	   command-args ("dap" "--listen" "localhost::autoport")
	   port :autoport
     ))))

(defun my/dape-debug-go-main ()
  "Запуск отладки текущего Go-теста с dape-mode."
  (interactive)
  (let ((test-package (go-test--gb-find-package)))
	(message "Current packet: %s" test-package)
	;;(message "Current file testing data: %s" (go-test--get-current-file-testing-data))
    (dape
     `(:name "Debug Go Main"
       :type "debug"
       :request "launch"
       :mode "debug"
	   :cwd "."
       :program "." ;;,(expand-file-name (buffer-file-name)) ; Путь к текущему файлу
       :args ["run" test-package] ; Запуск конкретного теста
       command "dlv" ;;,(executable-find "dlv") ; Путь к dlv (автоматически ищется в PATH)
	   command-cwd ,test-package
       command-insert-stderr t
	   command-args ("dap" "--listen" "localhost::autoport")
	   port :autoport
     ))))


;;(bind-key "C-c t d" 'my/dape-debug-go-test go-mode-map)
#+end_src

** Common lisp support

Use slime for common lisp development

#+begin_src elisp
  ;; Additional packages for Common Lisp
  (use-package slime
    :ensure t)

  (use-package slime-company
    :ensure t)

  (require 'slime-autoloads)

  (setq slime-autoloads '(".slime-autoloads.lisp"))

  (add-hook 'common-lisp-mode-hook 'lsp-deferred)

  ;; Configure SBCL as the Lisp program for SLIME.
  (add-to-list 'exec-path "/usr/bin")
  (setq inferior-lisp-program "sbcl")

  (eval-after-load 'company
    '(add-to-list 'company-backends 'company-slime))
  (slime-setup '(slime-fancy slime-company))

  ;; CIDER updated function
(defun cider-eval-end-of-sexp (arg)
  (interactive "P")
  (save-excursion
    (forward-char)
    (cider-eval-last-sexp arg)))

#+end_src

** Database/SQL Support
Set up database and SQL support:

#+begin_src elisp
(org-babel-do-load-languages
 'org-babel-load-languages
 '((sql . t)))

(setq sql-postgres-program "/usr/bin/psql")


;; (use-package pg
;;   :vc (:url "https://github.com/emarsden/pg-el/" :rev :newest))

;; (use-package pgmacs
;;   :vc (:url "https://github.com/emarsden/pgmacs/" :rev :newest))
#+end_src

** Python Development
Basic Python setup:

#+begin_src elisp
(use-package python
  :ensure t
  :mode "\\.py\\'"
  :interpreter "python")
#+end_src

* Org Mode Enhancements
Configure Org mode with PlantUML support:

#+begin_src elisp
(use-package plantuml-mode
  :ensure t)

(setq org-plantuml-jar-path (expand-file-name "/home/denis/Projects/arch/plantuml-mit-1.2025.2.jar"))
(add-to-list 'org-src-lang-modes '("plantuml" . plantuml))
(org-babel-do-load-languages 'org-babel-load-languages '((plantuml . t) (emacs-lisp . t) (sql .t)))
#+end_src

Use org-modern to display the org file beautifully.

#+begin_src elisp
(use-package org-modern
  :ensure t
  :hook
  (org-mode . org-modern-mode))

(add-hook 'org-agenda-finalize-hook #'org-modern-agenda)
#+end_src

Recreate table of contents on save org file which contains =:TOC_3:= like tag

#+begin_src elisp
  (use-package toc-org
  :ensure t)
#+end_src

Add formatting for json values in table. Useful in sql results.

  #+begin_src elisp
  (defun my-org-extract-and-show-json ()
    "Извлечь JSON из текущей ячейки таблицы и показать с форматированием"
    (interactive)
    (when (org-at-table-p)
      (let* ((element (org-element-at-point))
             (table (org-element-lineage element '(table) t))
             (value (org-table-get (org-table-current-line)
                                  (org-table-current-column))))
        (if (and value (string-match-p "[{\\[]" value)) ; Проверка на JSON
            (my-show-formatted-json value)
          (message "Current cell doesn't contain JSON data")))))

  (defun my-show-formatted-json (json-string)
    "Показать отформатированный JSON в отдельном буфере"
    (let ((json-buffer (get-buffer-create "*Formatted JSON*")))
      (with-current-buffer json-buffer
        (erase-buffer)
        (insert (my-beautify-json json-string))
        (when (fboundp 'json-mode)
          (json-mode))
        (goto-char (point-min)))
      (display-buffer json-buffer '(display-buffer-pop-up-window . nil))))

  (defun my-beautify-json (json-str)
    "Украсить JSON строку"
    (condition-case err
        (let* ((json-object (json-read-from-string json-str))
               (temp-buffer (generate-new-buffer " *json-temp*")))
          (with-current-buffer temp-buffer
            (insert (json-encode json-object))
            (json-pretty-print-buffer)
            (let ((result (buffer-string)))
              (kill-buffer temp-buffer)
              result)))
      (error
       (kill-buffer temp-buffer)
       (format "Error parsing JSON: %s\nOriginal: %s"
               (error-message-string err) json-str))))

  (defun my-org-auto-format-json-at-point ()
    "Автоматически форматировать JSON при наведении курсора"
    (interactive)
    (when (org-at-table-p)
      (let ((cell-content (org-table-get-field)))
        (when (and cell-content
                   (or (string-prefix-p "{" cell-content)
                       (string-prefix-p "[" cell-content)))
          (my-show-formatted-json cell-content)))))

  ;; Автоматический запуск при переходе по таблице
  (add-hook 'org-table-follow-field-hook 'my-org-auto-format-json-at-point)
#+end_src

* AI
Use LLM

#+begin_src elisp
  (use-package gptel
    :ensure t
    :config
    (gptel-make-openai "LMStudio"
    			:protocol "http"
    			:host "localhost:1234"
    			:key "test"
    			:stream t
    			:models '(qwen/qwen3-4b openai/gpt-oss-20b minimaxai.minimax-m2))
    (setq gptel-default-provider "LMStudio")
    (setq gptel-model "openai/gpt-oss-20b"))

  (use-package gptel-agent
    :vc ( :url "https://github.com/karthink/gptel-agent"
          :rev :newest)
    :config (gptel-agent-update))

#+end_src


* Version Control
Configure Magit for Git workflows:

#+begin_src elisp
(use-package magit
  :ensure t
  :bind (("C-c g" . magit-status))
  :config
  (setq magit-stage-all-confirm nil
        magit-unstage-all-confirm nil
        magit-save-repository-buffers 'dont-ask))
#+end_src

* Dashboard

#+begin_src elisp
  ;;(use-package page-break-lines
  ;;	:ensure t)

  (use-package dashboard
    :ensure t
    :init (setq dashboard-display-icons-p t
  			  dashboard-icon-type 'all-the-icons
  			  dashboard-set-heading-icons t
  			  dashboard-set-file-icons t
  			  dashboard-center-content t
  			  dashboard-startup-banner 'logo
  			  dashboard-vertically-center-content t
  			  dashboard-projects-backend 'project-el)
    :config
    (dashboard-setup-startup-hook)
    (setq dashboard-items '((recents   . 5)
  						  (bookmarks . 5)
  						  (projects  . 5)
  						  (agenda    . 5)
  						  (registers . 5))))
#+end_src



* Key Bindings
Finally, we'll set up a comprehensive key binding system using General.el for a consistent experience.

** Leader Key Definition
We'll define a Spacemacs-like leader key for common operations:

#+begin_src elisp
(use-package general
  :ensure t
  :config
  ;; Define the leader key
  (general-create-definer leader-def
    :states 'motion
    :keymaps 'override
    :prefix "SPC"
    :global-prefix "M-SPC")

  ;; Define program-specific prefix
  (general-create-definer prog-def
    :prefix "C-c")

  ;; Program-specific bindings
  (prog-def
    "a" '(eglot-code-actions :which-key "code actions")
    "r" '(eglot-rename :which-key "rename")
    "o" '(eglot-code-action-organize-imports :which-key "organize imports")
    "h" '(eldoc :which-key "doc"))

  ;; File operations
  (leader-def
    "f" '(:ignore t :which-key "file")
    "f f" '(counsel-find-file :which-key "find file")
    "f s" '(save-buffer :which-key "save file"))

  ;; Search
  (leader-def
    "/" 'counsel-rg)

  ;; Sexp manipulation (for Lisp-like languages)
  (leader-def
    "k" '(:ignore t :which-key "sexp")
    "k w" '(sp-wrap-round :which-key "wrap ()")
    "k [" '(sp-wrap-square :which-key "wrap []")
    "k {" '(sp-wrap-curly :which-key "wrap {}")
    "k ," '(sp-forward-barf-sexp :which-key "barf <-)")
    "k ." '(sp-forward-slurp-sexp :which-key "slurp ->)")
    "k <" '(sp-backward-barf-sexp :which-key "barf (-<")
    "k >" '(sp-forward-slurp-sexp :which-key "slurp (>->")
    "k d" '(sp-kill-sexp :which-key "delete sexp")
    "k r" '(sp-raise-sexp :which-key "raise sexp")
    "k y" '(sp-copy-sexp :which-key "copy sexp"))

  ;; Window management
  (leader-def
    "w" '(:ignore t :which-key "window")
    "w v" '(split-window-right :which-key "split vertically")
    "w s" '(split-window-below :which-key "split horizontally")
    "w k" '(windmove-up :which-key "focus ↑")
    "w h" '(windmove-left :which-key "focus ←")
    "w j" '(windmove-down :which-key "focus ↓")
    "w l" '(windmove-right :which-key "focus →")
    "w d" '(delete-window :which-key "delete window"))

  ;; Buffer management
  (leader-def
    "b" '(:ignore t :which-key "buffer")
    "b b" '(ivy-switch-buffer :which-key "switch buffer")
    "b l" '(previous-buffer :which-key "last buffer")
    "b d" 'kill-current-buffer)

  ;; Code operations
  (leader-def
    "c" '(:ignore t :which-key "code")
    "c a" 'eglot-code-actions
    "c l" 'comment-or-uncomment-region
    "c f b" 'eglot-format-buffer
    "c f r" 'eglot-format
    "c w s" 'word-to-underscore
    "c r" 'eglot-rename)

  ;; Navigation
  (leader-def
    "g" '(:ignore t :which-key "goto")
    "g d" 'xref-find-definitions
    "g b" 'xref-go-back
    "g f" 'xref-go-forward
    "g i" 'xref-find-implementation)

  ;; Project operations
  (leader-def
    "p" '(:ignore t :which-key "project")
    "p f" '(projectile-find-file :which-key "find file in project")
    "p g" '(projectile-grep :which-key "grep in project")
    "p a" '(projectile-toggle-between-implementation-and-test :which-key "<-> test")
    "p p" '(projectile-switch-project :which-key "switch project"))

  ;; Open operations
  (leader-def
    "o" '(:ignore t :which-key "open")
    "o p" 'treemacs)

  ;; Execute command
  (leader-def
    "SPC" '(execute-extended-command :which-key "M-x"))

  ;; Ivy navigation
  (general-define-key
   :keymaps 'ivy-mode-map
   "C-j" 'ivy-next-line
   "C-k" 'ivy-previous-line)

  ;; Emacs Lisp specific bindings
  (leader-def
    :keymaps 'emacs-lisp-mode-map
    "m" '(:ignore t :which-key "emacs lisp")
    "m e" '(:ignore t :which-key "eval")
    "m e e" 'eval-last-sexp
    "m e d" 'eval-defun
    "m e b" 'eval-buffer)

  ;; Clojure specific bindings
  (leader-def
    :keymaps 'clojure-mode-map
    "m" '(:ignore t :which-key "clojure")
    "m e" '(:ignore t :which-key "eval")
    "m e e" 'cider-eval-end-of-sexp
    "m e d" 'cider-eval-defun-at-point
    "m c" 'cider-connect-clj
    "m e b" 'cider-eval-buffer
    "m r n" 'cider-repl-set-ns
    "m g g" 'xref-find-definitions
    "m r r" 'eglot-rename
    "m t r" 'cider-test-run-test
    "m t n" 'cider-test-run-ns-tests
    "m d d" 'cider-doc)

  ;; Escape key configuration
  (general-define-key
   "<escape>" 'keyboard-escape-quit))
#+end_src


* My additional functions
** UUID generation

#+begin_src elisp
;; UUID Generation Function
(defun xah-insert-random-uuid ()
  "Insert a UUID.
This commands calls “uuidgen” on MacOS, Linux, and calls PowelShell on Microsoft Windows.
URL `http://xahlee.info/emacs/emacs/elisp_generate_uuid.html'
Version 2020-06-04"
  (interactive)
  (cond
   ((string-equal system-type "windows-nt")
    (shell-command "pwsh.exe -Command [guid]::NewGuid().toString()" t))
   ((string-equal system-type "darwin") ; Mac
    (shell-command "uuidgen" t))
   ((string-equal system-type "gnu/linux")
    (insert (substring (shell-command-to-string "uuidgen") 0 36)))
   (t
    ;; code here by Christopher Wellons, 2011-11-18.
    ;; and editted Hideki Saito further to generate all valid variants for "N" in xxxxxxxx-xxxx-Mxxx-Nxxx-xxxxxxxxxxxx format.
    (let ((myStr (md5 (format "%s%s%s%s%s%s%s%s%s%s"
                              (user-uid)
                              (emacs-pid)
                              (system-name)
                              (user-full-name)
                              (current-time)
                              (emacs-uptime)
                              (garbage-collect)
                              (buffer-string)
                              (random)
                              (recent-keys)))))
      (insert (format "%s-%s-4%s-%s%s-%s"
                      (substring myStr 0 8)
                      (substring myStr 8 12)
                      (substring myStr 13 16)
                      (format "%x" (+ 8 (random 4)))
                      (substring myStr 17 20)
                      (substring myStr 20 32)))))))  
#+end_src

** Text transformation

#+begin_src elisp
;; Text transformation functions
(defun to-underscore ()
  "To snake case."
  (interactive)
  (progn (replace-regexp "\\([A-Z]\\)" "_\\1" nil (region-beginning) (region-end))
		 (downcase-region (region-beginning) (region-end))))

(defun word-to-underscore ()
  "Word to snake case."
  (interactive)
  (save-excursion
	(let ((bounds (bounds-of-thing-at-point 'word)))
	  (replace-regexp "\\([A-Z]\\)" "_\\1" nil (1+ (car bounds)) (cdr bounds))
	  (downcase-region (car bounds) (cdr bounds)))))  
#+end_src


* Final Settings
Wrap up with some final configuration settings and cleanup:

#+begin_src elisp
;; Allow custom variables to be saved properly
(setq custom-safe-things t)

;; Provide the configuration
(provide 'init)
;;; init.el ends here
#+end_src
